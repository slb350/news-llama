{% extends "base.html" %}

{% block title %}Calendar - News Llama{% endblock %}

{% block content %}
<!-- Header Card -->
<div class="card-static shadow-lg p-6 mb-6">
    <div class="flex items-center justify-between">
        <!-- User Info -->
        <div class="flex items-center gap-4">
            <div class="profile-avatar profile-avatar-small">
                {% if user.avatar_path %}
                    <img src="/static/avatars/{{ user.avatar_path }}" alt="{{ user.first_name }}" class="w-full h-full object-cover rounded-full">
                {% else %}
                    {{ user.first_name[0] }}
                {% endif %}
            </div>
            <div>
                <h2 class="text-2xl font-bold text-gray-900">{{ user.first_name }}'s Newsletters</h2>
                <p class="text-sm text-gray-500">Daily AI-Powered News Digest</p>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex items-center gap-3">
            <!-- Polling Indicator -->
            <div id="polling-indicator" class="hidden">
                <div class="flex items-center gap-2 text-xs text-gray-500">
                    <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
                    <span>Checking for updates...</span>
                </div>
            </div>

            <a href="/profile/settings"
               hx-get="/profile/settings"
               hx-trigger="click"
               hx-target="body"
               hx-swap="innerHTML"
               hx-push-url="true"
               class="btn-secondary">
                ‚öôÔ∏è Settings
            </a>
            <a href="/"
               hx-get="/"
               hx-trigger="click"
               hx-target="body"
               hx-swap="innerHTML"
               hx-push-url="true"
               class="btn-secondary">
                üë§ Switch Profile
            </a>
        </div>
    </div>
</div>

<!-- Calendar Card -->
<div class="card-static shadow-lg p-6">
    <!-- Month Navigation -->
    <div class="flex items-center justify-between mb-6">
        {% set prev_month = month - 1 if month > 1 else 12 %}
        {% set prev_year = year if month > 1 else year - 1 %}
        {% set next_month = month + 1 if month < 12 else 1 %}
        {% set next_year = year if month < 12 else year + 1 %}

        <button
            class="btn-secondary px-4 py-2"
            hx-get="/calendar/{{ prev_year }}/{{ prev_month }}"
            hx-target="body"
            hx-swap="innerHTML"
            hx-push-url="true"
        >
            ‚Üê Previous
        </button>

        <h3 class="text-2xl font-bold text-gray-900">{{ current_month }}</h3>

        <button
            class="btn-secondary px-4 py-2"
            hx-get="/calendar/{{ next_year }}/{{ next_month }}"
            hx-target="body"
            hx-swap="innerHTML"
            hx-push-url="true"
        >
            Next ‚Üí
        </button>
    </div>

    <!-- Empty State -->
    {% if newsletters|length == 0 %}
        {% if has_active %}
        <div class="empty-state py-12 text-center" data-state="generating">
            <div class="text-6xl mb-4">‚öôÔ∏è</div>
            <h3 class="text-2xl font-bold text-gray-900 mb-2">Newsletter Generating...</h3>
            <p class="text-gray-600 mb-2">Your first newsletter is being created! This may take 10-15 minutes.</p>
            <p class="text-sm text-gray-500">The page will automatically update when ready.</p>
        </div>
        {% else %}
        <div class="empty-state py-12 text-center" data-state="empty">
            <div class="text-6xl mb-4">üì∞</div>
            <h3 class="text-2xl font-bold text-gray-900 mb-2">No Newsletters Yet</h3>
            <p class="text-gray-600 mb-6">Get started by generating your first AI-powered news digest!</p>
            <button
                onclick="generateTodayNewsletter()"
                class="btn-primary"
                data-loading-text="Generating..."
            >
                ‚ú® Generate Today's Newsletter
            </button>
        </div>
        <script>
            /**
             * Generate newsletter for today's date
             * Queues generation job and reloads page after 2 seconds
             * @fires NewsLlama.showToast - Success or error message
             */
            async function generateTodayNewsletter() {
            const today = new Date().toISOString().split('T')[0];
            try {
                const response = await fetch('/newsletters/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date: today })
                });
                if (response.ok) {
                    NewsLlama.showToast('Newsletter queued! Generation will begin shortly.', 'success');
                    setTimeout(() => window.location.reload(), 2000);
                } else if (response.status === 401) {
                    // No profile selected - redirect to profile selection
                    window.location.href = '/';
                } else {
                    // Handle error with safe JSON parsing
                    let errorMessage = 'Failed to generate newsletter.';
                    try {
                        const error = await response.json();
                        errorMessage = error.detail || errorMessage;
                    } catch (parseError) {
                        // Response wasn't JSON (e.g., 500 HTML page)
                        console.error('Failed to parse error response:', parseError.message);
                    }
                    NewsLlama.showToast(errorMessage, 'error');
                }
            } catch (error) {
                console.error('Newsletter generation error:', error.message);
                NewsLlama.showToast('Failed to generate newsletter. Please try again.', 'error');
            }
        }
        </script>
        {% endif %}
    {% else %}
    <!-- Calendar Grid -->
    <div id="calendar-container">
        <!-- Day Headers -->
        <div class="calendar-grid mb-2">
            <div class="text-center text-xs font-semibold text-gray-500 uppercase">Sun</div>
            <div class="text-center text-xs font-semibold text-gray-500 uppercase">Mon</div>
            <div class="text-center text-xs font-semibold text-gray-500 uppercase">Tue</div>
            <div class="text-center text-xs font-semibold text-gray-500 uppercase">Wed</div>
            <div class="text-center text-xs font-semibold text-gray-500 uppercase">Thu</div>
            <div class="text-center text-xs font-semibold text-gray-500 uppercase">Fri</div>
            <div class="text-center text-xs font-semibold text-gray-500 uppercase">Sat</div>
        </div>

        <!-- Calendar Days (Mockup with static data) -->
        <div class="calendar-grid">
            <!-- Empty days (padding for month start) -->
            <div class="calendar-day opacity-30">
                <span class="text-sm font-semibold">26</span>
            </div>
            <div class="calendar-day opacity-30">
                <span class="text-sm font-semibold">27</span>
            </div>
            <div class="calendar-day opacity-30">
                <span class="text-sm font-semibold">28</span>
            </div>
            <div class="calendar-day opacity-30">
                <span class="text-sm font-semibold">29</span>
            </div>
            <div class="calendar-day opacity-30">
                <span class="text-sm font-semibold">30</span>
            </div>
            <div class="calendar-day opacity-30">
                <span class="text-sm font-semibold">31</span>
            </div>

            <!-- Calendar days -->
            {% set days_in_month = [0, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31][month] %}
            {% if month == 2 and (year % 4 == 0 and (year % 100 != 0 or year % 400 == 0)) %}
                {% set days_in_month = 29 %}
            {% endif %}
            {% for day in range(1, days_in_month + 1) %}
                {% set date_str = "%04d-%02d-%02d"|format(year, month, day) %}
                {% set has_newsletter = newsletters|selectattr('date', 'equalto', date_str)|list|length > 0 %}
                {% set newsletter = newsletters|selectattr('date', 'equalto', date_str)|first if has_newsletter else none %}
                {% set is_today = (today.year == year and today.month == month and today.day == day) %}

                {% if has_newsletter and newsletter.status == 'completed' %}
                <div class="calendar-day has-newsletter
                    {% if is_today %}today{% endif %}"
                    data-newsletter-guid="{{ newsletter.guid }}"
                    data-newsletter-date="{{ newsletter.date }}"
                    data-newsletter-status="{{ newsletter.status }}">
                {% elif has_newsletter and newsletter.status == 'failed' %}
                <div class="calendar-day failed
                    {% if is_today %}today{% endif %}"
                    data-newsletter-guid="{{ newsletter.guid }}"
                    data-newsletter-date="{{ newsletter.date }}"
                    data-newsletter-status="{{ newsletter.status }}"
                    data-retry-count="{{ newsletter.retry_count }}">
                {% else %}
                <div class="calendar-day
                    {% if has_newsletter and newsletter.status == 'pending' %}pending{% endif %}
                    {% if has_newsletter and newsletter.status == 'generating' %}generating{% endif %}
                    {% if is_today %}today{% endif %}"
                    {% if has_newsletter %}data-newsletter-guid="{{ newsletter.guid }}" data-newsletter-date="{{ newsletter.date }}" data-newsletter-status="{{ newsletter.status }}"{% endif %}>
                {% endif %}
                    <span class="text-sm font-semibold">{{ day }}</span>
                    {% if has_newsletter and newsletter.status == 'completed' %}
                        <span class="text-xs mt-1">ü¶ô</span>
                    {% elif has_newsletter and newsletter.status == 'pending' %}
                        <span class="text-xs mt-1">‚è≥</span>
                    {% elif has_newsletter and newsletter.status == 'generating' %}
                        <span class="text-xs mt-1 generating-spinner">‚öôÔ∏è</span>
                    {% elif has_newsletter and newsletter.status == 'failed' %}
                        <span class="text-xs mt-1">‚ùå</span>
                    {% endif %}
                </div>
            {% endfor %}

            <!-- Padding for rest of week -->
            <div class="calendar-day opacity-30">
                <span class="text-sm font-semibold">1</span>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Legend -->
    {% if newsletters|length > 0 %}
    <div class="mt-6 pt-6 border-t border-gray-200">
        <div class="flex gap-4 justify-center text-sm flex-wrap">
            <div class="flex items-center gap-2">
                <div class="w-6 h-6 rounded bg-white border-2 border-coral-accent"></div>
                <span class="text-gray-600">Today</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-6 h-6 rounded coral-bg flex items-center justify-center text-xs">ü¶ô</div>
                <span class="text-gray-600">Ready</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-6 h-6 rounded border-2 border-dashed border-gray-400 flex items-center justify-center text-xs">‚è≥</div>
                <span class="text-gray-600">Queued</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-6 h-6 rounded border-2 border-dashed border-blue-400 flex items-center justify-center text-xs">‚öôÔ∏è</div>
                <span class="text-gray-600">Generating</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-6 h-6 rounded border-2 border-red-400 flex items-center justify-center text-xs">‚ùå</div>
                <span class="text-gray-600">Failed</span>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Stats Card -->
<div class="card-static shadow-lg p-6 mt-6">
    <div class="grid grid-cols-4 gap-4">
        <div class="stats-box">
            <div class="stats-number coral-accent">{{ newsletters|length }}</div>
            <div class="stats-label">This Month</div>
        </div>
        <div class="stats-box">
            <div class="stats-number">{{ newsletters|selectattr('status', 'equalto', 'completed')|list|length }}</div>
            <div class="stats-label">Completed</div>
        </div>
        <div class="stats-box">
            <div class="stats-number">{{ newsletters|selectattr('status', 'equalto', 'pending')|list|length }}</div>
            <div class="stats-label">Pending</div>
        </div>
        <div class="stats-box">
            <div class="stats-number">365</div>
            <div class="stats-label">Days Retention</div>
        </div>
    </div>
</div>

<!-- Newsletter Modal -->
<div id="newsletter-modal" class="newsletter-modal" style="display: none;">
    <div class="newsletter-modal-content">
        <div class="newsletter-modal-header">
            <p class="text-sm text-gray-700 font-medium" id="modal-date"></p>
            <button onclick="closeNewsletterModal()" class="newsletter-modal-close">
                ‚úï Close
            </button>
        </div>
        <iframe id="newsletter-iframe" class="newsletter-modal-iframe"></iframe>
    </div>
</div>

<script>
    // Toast notification system provided by base.html globally as NewsLlama.showToast()

    // Configuration constants
    const POLL_INTERVAL_MS = 30 * 1000;  // 30 seconds

    /**
     * Open newsletter modal to view completed newsletter
     * @param {string} guid - Newsletter unique identifier
     * @param {string} date - Newsletter date in YYYY-MM-DD format
     */
    function openNewsletterModal(guid, date) {
        const modal = document.getElementById('newsletter-modal');
        const iframe = document.getElementById('newsletter-iframe');
        const dateEl = document.getElementById('modal-date');

        // Format date nicely - parse as local date to avoid timezone issues
        const [year, month, day] = date.split('-').map(Number);
        const dateObj = new Date(year, month - 1, day);  // month is 0-indexed
        const formattedDate = dateObj.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        dateEl.textContent = formattedDate;

        // Add cache buster to ensure fresh content
        const cacheBuster = `?v=${new Date().getTime()}`;
        iframe.src = `/newsletters/${guid}${cacheBuster}`;

        modal.style.display = 'flex';

        // Prevent body scroll
        document.body.style.overflow = 'hidden';
    }

    /**
     * Close newsletter modal and clean up
     * Restores body scroll and clears iframe source
     */
    function closeNewsletterModal() {
        const modal = document.getElementById('newsletter-modal');
        const iframe = document.getElementById('newsletter-iframe');

        modal.style.display = 'none';
        iframe.src = '';

        // Restore body scroll
        document.body.style.overflow = '';
    }

    // Close on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeNewsletterModal();
        }
    });

    // Close on background click
    document.getElementById('newsletter-modal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeNewsletterModal();
        }
    });

    // Add click handlers for completed newsletters (safe from XSS)
    document.addEventListener('click', function(e) {
        const completedDay = e.target.closest('.calendar-day.has-newsletter');
        if (completedDay) {
            const guid = completedDay.dataset.newsletterGuid;
            const date = completedDay.dataset.newsletterDate;
            openNewsletterModal(guid, date);
        }
    });

    // Add click handlers for failed newsletters (safe from XSS)
    document.addEventListener('click', function(e) {
        const failedDay = e.target.closest('.calendar-day.failed');
        if (failedDay) {
            const guid = failedDay.dataset.newsletterGuid;
            const date = failedDay.dataset.newsletterDate;
            const retryCount = parseInt(failedDay.dataset.retryCount, 10);
            handleFailedNewsletter(guid, date, retryCount);
        }
    });

    // Handle Failed Newsletter Click
    async function handleFailedNewsletter(guid, date, retryCount) {
        const maxRetries = 3;

        // Format date nicely
        const dateObj = new Date(date);
        const formattedDate = dateObj.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        let message;
        if (retryCount >= maxRetries) {
            message = `Newsletter for ${formattedDate} has failed after ${maxRetries} attempts. Maximum retry limit reached.`;
            NewsLlama.showToast(message, 'error');
            return;
        }

        message = `Newsletter for ${formattedDate} failed to generate. Would you like to retry?\n\n(Attempt ${retryCount + 1} of ${maxRetries})`;

        if (confirm(message)) {
            await retryNewsletter(guid);
        }
    }

    // Retry Failed Newsletter
    async function retryNewsletter(guid) {
        try {
            const response = await fetch(`/newsletters/${guid}/retry`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();
                NewsLlama.showToast('Newsletter queued for retry! Generation will begin shortly.', 'success');

                // Update the calendar day display
                const dayEl = document.querySelector(`[data-newsletter-guid="${guid}"]`);
                if (dayEl) {
                    dayEl.dataset.newsletterStatus = 'pending';
                    updateNewsletterDayDisplay(dayEl, 'pending');
                }
            } else {
                // Handle error with safe JSON parsing
                let errorMessage = 'Failed to retry newsletter.';
                try {
                    const error = await response.json();
                    errorMessage = error.detail || errorMessage;
                } catch (parseError) {
                    // Response wasn't JSON (e.g., 500 HTML page)
                    console.error('Failed to parse error response:', parseError.message);
                }
                NewsLlama.showToast(errorMessage, 'error');
            }
        } catch (error) {
            console.error('Failed to retry newsletter:', error.message);
            NewsLlama.showToast('Failed to retry newsletter. Please try again.', 'error');
        }
    }

    // Newsletter Status Polling
    let pollingInterval = null;

    /**
     * Poll newsletter status for all active (pending/generating) newsletters
     * Updates UI when status changes and shows toast notifications
     * Shows/hides polling indicator based on active newsletter count
     * @fires NewsLlama.showToast - When newsletter completes or fails
     */
    function pollNewsletterStatus() {
        const indicator = document.getElementById('polling-indicator');

        // Find all calendar days with pending or generating newsletters
        const activeDays = document.querySelectorAll('[data-newsletter-guid][data-newsletter-status]');

        // Filter to only pending or generating
        const activePollingDays = Array.from(activeDays).filter(dayEl => {
            const status = dayEl.dataset.newsletterStatus;
            return status === 'pending' || status === 'generating';
        });

        // If no active newsletters, hide indicator and return
        if (activePollingDays.length === 0) {
            if (indicator) indicator.classList.add('hidden');
            return;
        }

        // Show indicator
        if (indicator) indicator.classList.remove('hidden');

        // Poll all active newsletters
        Promise.all(activePollingDays.map(async (dayEl) => {
            const guid = dayEl.dataset.newsletterGuid;
            const currentStatus = dayEl.dataset.newsletterStatus;

            try {
                    const response = await fetch(`/newsletters/${guid}`);

                    // Check content type to determine if it's JSON or HTML
                    const contentType = response.headers.get('content-type');

                    if (contentType && contentType.includes('application/json')) {
                        // It's JSON - parse and process status update
                        const data = await response.json();

                        // Check if status changed
                        if (data.status !== currentStatus) {
                            console.log(`Newsletter ${guid} status changed: ${currentStatus} ‚Üí ${data.status}`);

                            // Update data attribute
                            dayEl.dataset.newsletterStatus = data.status;

                            // Update classes and icon
                            updateNewsletterDayDisplay(dayEl, data.status);

                            // Show toast for completed or failed
                            if (data.status === 'completed') {
                                NewsLlama.showToast('Newsletter ready! Click the date to view.', 'success');
                            } else if (data.status === 'failed') {
                                NewsLlama.showToast('Newsletter generation failed. Please try again.', 'error');
                            }
                        }
                    } else if (contentType && contentType.includes('text/html')) {
                        // It's HTML - newsletter is completed and ready
                        console.log(`Newsletter ${guid} is completed and file is ready`);

                        // Update status to completed
                        dayEl.dataset.newsletterStatus = 'completed';
                        updateNewsletterDayDisplay(dayEl, 'completed');

                        // Show toast
                        NewsLlama.showToast('Newsletter ready! Click the date to view.', 'success');
                    }
            } catch (error) {
                console.error(`Failed to poll newsletter ${guid}:`, error.message);
            }
        })).then(() => {
            // Hide indicator when done (with slight delay for UX)
            setTimeout(() => {
                if (indicator) indicator.classList.add('hidden');
            }, 500);
        });
    }

    /**
     * Update calendar day display based on newsletter status
     * Changes icon, classes, and click handlers based on status
     * @param {HTMLElement} dayEl - Calendar day element to update
     * @param {string} status - Newsletter status (completed/generating/pending/failed)
     */
    function updateNewsletterDayDisplay(dayEl, status) {
        // Remove old status classes
        dayEl.classList.remove('pending', 'generating', 'failed');

        // Find the icon element
        const iconEl = dayEl.querySelector('.text-xs');

        if (status === 'completed') {
            // Make clickable
            dayEl.classList.add('has-newsletter');
            const guid = dayEl.dataset.newsletterGuid;
            const date = dayEl.dataset.newsletterDate || '';
            dayEl.onclick = () => openNewsletterModal(guid, date);
            if (iconEl) iconEl.textContent = 'ü¶ô';
        } else if (status === 'generating') {
            dayEl.classList.add('generating');
            if (iconEl) {
                iconEl.textContent = '‚öôÔ∏è';
                iconEl.classList.add('generating-spinner');
            }
        } else if (status === 'failed') {
            dayEl.classList.add('failed');
            if (iconEl) iconEl.textContent = '‚ùå';
        } else if (status === 'pending') {
            dayEl.classList.add('pending');
            if (iconEl) iconEl.textContent = '‚è≥';
        }
    }

    // Start polling when page loads
    pollingInterval = setInterval(pollNewsletterStatus, POLL_INTERVAL_MS);

    // Poll immediately on page load
    pollNewsletterStatus();

    // Stop polling when navigating away
    window.addEventListener('beforeunload', () => {
        if (pollingInterval) {
            clearInterval(pollingInterval);
        }
    });
</script>
{% endblock %}
