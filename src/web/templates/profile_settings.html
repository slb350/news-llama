{% extends "base.html" %}

{% block title %}Profile Settings - News Llama{% endblock %}

{% block content %}
<div class="card-static shadow-lg p-8">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Profile Settings</h1>
            <p class="text-sm text-gray-500 uppercase tracking-wide">Manage Your Account</p>
        </div>
        <a href="/calendar"
           hx-get="/calendar"
           hx-trigger="click"
           hx-target="body"
           hx-swap="innerHTML"
           hx-push-url="true"
           class="btn-secondary">
            ‚Üê Back to Calendar
        </a>
    </div>

    <!-- Form -->
    <form id="settings-form" class="space-y-8">

        <!-- Profile Information Section -->
        <div class="border-b border-gray-200 pb-8">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Profile Information</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Name -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" for="first_name">
                        First Name
                    </label>
                    <input
                        type="text"
                        id="first_name"
                        name="first_name"
                        value="{{ user.first_name }}"
                        required
                        minlength="1"
                        maxlength="100"
                        class="w-full"
                        aria-label="First name"
                        aria-required="true"
                    >
                </div>

                <!-- Avatar Upload -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Profile Avatar
                    </label>
                    <div class="flex items-center gap-4">
                        <div class="profile-avatar" style="width: 80px; height: 80px; font-size: 2rem;" id="avatar-preview">
                            {% if user.avatar_path %}
                                <img src="/static/avatars/{{ user.avatar_path }}" alt="{{ user.first_name }}" class="w-full h-full object-cover rounded-full">
                            {% else %}
                                {{ user.first_name[0] }}
                            {% endif %}
                        </div>
                        <div class="flex-1">
                            <input
                                type="file"
                                id="avatar"
                                name="avatar"
                                accept="image/*"
                                class="hidden"
                                onchange="handleAvatarSelect(this)"
                            >
                            <label for="avatar" class="btn-secondary inline-block mb-2 cursor-pointer">
                                Change Avatar
                            </label>
                            <p class="text-xs text-gray-500">Max 500KB, 512x512px</p>
                            <p id="avatar-status" class="text-xs mt-1"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Interests Section -->
        <div class="border-b border-gray-200 pb-8">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Your Interests</h2>

            <!-- Selected Interests -->
            <div class="coral-bg-light rounded-lg p-4 mb-4 min-h-[60px]">
                <div class="text-xs text-gray-600 uppercase tracking-wide font-semibold mb-2">
                    Selected Interests (click to remove)
                </div>
                <div id="selected-interests" class="flex flex-wrap gap-2">
                    {% if user_interests %}
                        {% for interest in user_interests %}
                        <span class="interest-tag cursor-pointer hover:opacity-80" data-interest="{{ interest }}">
                            {{ interest }}
                        </span>
                        {% endfor %}
                    {% else %}
                        <span class="text-xs text-gray-500 empty-state">
                            No interests selected yet. Add your interests to personalize your news!
                        </span>
                    {% endif %}
                </div>
            </div>

            <!-- Custom Interest Input -->
            <div class="mb-4">
                <div class="flex gap-2">
                    <input
                        type="text"
                        id="custom-interest"
                        placeholder="Add custom interest..."
                        maxlength="100"
                        class="flex-1"
                        aria-label="Custom interest"
                    >
                    <button type="button" class="btn-secondary" onclick="addCustomInterest()">
                        Add
                    </button>
                </div>
            </div>

            <!-- Available Interests -->
            <div class="mb-2">
                <div class="text-xs text-gray-600 uppercase tracking-wide font-semibold mb-2">
                    Pre-configured Categories (click to add)
                </div>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2">
                {% for interest in available_interests %}
                <button
                    type="button"
                    class="interest-tag text-center {% if interest in user_interests %}selected{% endif %}"
                    onclick="toggleInterest(this, '{{ interest }}')"
                >
                    {{ interest }}
                </button>
                {% endfor %}
            </div>
        </div>

        <!-- Account Stats -->
        <div class="border-b border-gray-200 pb-8">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Account Statistics</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="stats-box">
                    <div class="stats-number coral-accent">{{ user_interests|length }}</div>
                    <div class="stats-label">Active Interests</div>
                </div>
                <div class="stats-box">
                    <div class="stats-number">22</div>
                    <div class="stats-label">Newsletters This Month</div>
                </div>
                <div class="stats-box">
                    <div class="stats-number">154</div>
                    <div class="stats-label">Total Newsletters</div>
                </div>
                <div class="stats-box">
                    <div class="stats-number">365</div>
                    <div class="stats-label">Days Retention</div>
                </div>
            </div>
        </div>

        <!-- Danger Zone -->
        <div>
            <h2 class="text-xl font-bold text-red-600 mb-4">Danger Zone</h2>
            <div class="border-2 border-red-200 rounded-lg p-4 bg-red-50">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="font-semibold text-gray-900">Delete Profile</h3>
                        <p class="text-sm text-gray-600">Permanently delete this profile and all newsletters</p>
                    </div>
                    <button
                        type="button"
                        class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition-colors"
                        onclick="confirm('Are you sure you want to delete this profile? This cannot be undone.') && alert('Delete functionality coming in Phase 3')"
                    >
                        Delete Profile
                    </button>
                </div>
            </div>
        </div>

        <!-- Submit Buttons -->
        <div class="flex gap-4 pt-6">
            <button type="submit" class="btn-primary flex-1" id="submit-btn">
                Save Changes
            </button>
            <a href="/calendar" class="btn-secondary flex-1 text-center">
                Cancel
            </a>
        </div>
    </form>
</div>

<script>
    // Initialize with existing interests
    const selectedInterests = new Set({{ user_interests|tojson }});
    let uploadedAvatarFile = null;

    // Add event delegation for interest removal (safe from XSS)
    document.getElementById('selected-interests').addEventListener('click', function(e) {
        const interestTag = e.target.closest('.interest-tag[data-interest]');
        if (interestTag && !interestTag.classList.contains('empty-state')) {
            const interest = interestTag.dataset.interest;
            removeInterest(interest);
        }
    });

    // Handle avatar file selection
    async function handleAvatarSelect(input) {
        const file = input.files[0];
        const statusEl = document.getElementById('avatar-status');
        const avatarPreview = document.getElementById('avatar-preview');

        if (!file) {
            return;
        }

        // Validate file type
        if (!file.type.startsWith('image/')) {
            statusEl.textContent = 'Please select an image file';
            statusEl.className = 'text-xs mt-1 text-red-600';
            return;
        }

        // Validate file size (500KB max)
        if (file.size > 500 * 1024) {
            statusEl.textContent = 'File size must be less than 500KB';
            statusEl.className = 'text-xs mt-1 text-red-600';
            return;
        }

        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
            avatarPreview.innerHTML = `<img src="${e.target.result}" alt="Avatar preview" class="w-full h-full object-cover rounded-full">`;
        };
        reader.readAsDataURL(file);

        // Upload immediately
        statusEl.textContent = 'Uploading...';
        statusEl.className = 'text-xs mt-1 text-blue-600';

        const formData = new FormData();
        formData.append('avatar', file);

        try {
            const response = await fetch('/profile/avatar', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                statusEl.textContent = 'Avatar uploaded successfully!';
                statusEl.className = 'text-xs mt-1 text-green-600';
            } else {
                // Parse error message from backend
                let errorMessage = 'Upload failed. Please try again.';
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.detail || errorMessage;
                } catch {
                    // Response wasn't JSON
                }
                statusEl.textContent = errorMessage;
                statusEl.className = 'text-xs mt-1 text-red-600';
                NewsLlama.showToast(errorMessage, 'error');
            }
        } catch (error) {
            console.error('Avatar upload error:', error.message);
            const errorMessage = 'Network error. Please check your connection.';
            statusEl.textContent = errorMessage;
            statusEl.className = 'text-xs mt-1 text-red-600';
            NewsLlama.showToast(errorMessage, 'error');
        }
    }

    function toggleInterest(button, interest) {
        if (selectedInterests.has(interest)) {
            selectedInterests.delete(interest);
            if (button) button.classList.remove('selected');
        } else {
            selectedInterests.add(interest);
            if (button) button.classList.add('selected');
        }
        updateSelectedDisplay();
    }

    function removeInterest(interest) {
        selectedInterests.delete(interest);
        // Also remove 'selected' class from the grid button if it exists
        const gridButtons = document.querySelectorAll('.interest-tag');
        gridButtons.forEach(btn => {
            if (btn.textContent.trim() === interest) {
                btn.classList.remove('selected');
            }
        });
        updateSelectedDisplay();
    }

    function addCustomInterest() {
        const input = document.getElementById('custom-interest');
        const interest = input.value.trim();
        if (interest && interest.length > 0) {
            selectedInterests.add(interest);
            updateSelectedDisplay();
            input.value = '';
        }
    }

    // Allow Enter key to add custom interest
    document.getElementById('custom-interest').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            addCustomInterest();
        }
    });

    function updateSelectedDisplay() {
        const container = document.getElementById('selected-interests');

        // Clear container
        container.innerHTML = '';

        if (selectedInterests.size === 0) {
            const span = document.createElement('span');
            span.className = 'text-xs text-gray-500 empty-state';
            span.textContent = 'No interests selected yet';
            container.appendChild(span);
        } else {
            // Create elements safely using DOM methods (no onclick, use data attributes)
            Array.from(selectedInterests).forEach(interest => {
                const span = document.createElement('span');
                span.className = 'interest-tag cursor-pointer hover:opacity-80';
                span.textContent = interest;  // Safe - sets text, not HTML
                span.dataset.interest = interest;  // Safe - use data attribute instead of onclick
                container.appendChild(span);
            });
        }
    }

    // Form submission handler
    document.getElementById('settings-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const firstName = document.getElementById('first_name').value.trim();
        const interests = Array.from(selectedInterests);

        if (!firstName) {
            alert('Please enter your first name');
            return;
        }

        // Disable submit button
        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Saving...';

        try {
            const response = await fetch('/profile/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    first_name: firstName,
                    interests: interests
                })
            });

            if (response.ok) {
                // Success - parse JSON response to be consistent
                const result = await response.json();
                if (result.status === 'success') {
                    // Redirect with success message in query string
                    window.location.href = '/calendar?toast=Profile updated successfully!&toast_type=success';
                } else {
                    throw new Error(result.message || 'Update failed');
                }
            } else {
                // Handle error with safe JSON parsing
                let errorMessage = 'An unexpected error occurred. Please try again.';
                try {
                    const error = await response.json();
                    errorMessage = error.detail || errorMessage;
                } catch (parseError) {
                    // Response wasn't JSON (e.g., 500 HTML page)
                    console.error('Failed to parse error response:', parseError.message);
                }
                throw new Error(errorMessage);
            }
        } catch (error) {
            console.error('Error:', error.message);
            alert(error.message || 'Network error. Please try again.');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Save Changes';
        }
    });
</script>
{% endblock %}
