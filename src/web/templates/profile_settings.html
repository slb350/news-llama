{% extends "base.html" %}

{% block title %}Profile Settings - News Llama{% endblock %}

{% block content %}
<div class="card-static shadow-lg p-8">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Profile Settings</h1>
            <p class="text-sm text-gray-500 uppercase tracking-wide">Manage Your Account</p>
        </div>
        <a href="/calendar"
           hx-get="/calendar"
           hx-trigger="click"
           hx-target="body"
           hx-swap="innerHTML"
           hx-push-url="true"
           class="btn-secondary">
            ‚Üê Back to Calendar
        </a>
    </div>

    <!-- Form -->
    <form id="settings-form" class="space-y-8">

        <!-- Profile Information Section -->
        <div class="border-b border-gray-200 pb-8">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Profile Information</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Name -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" for="first_name">
                        First Name
                        <span class="text-red-600" aria-label="required">*</span>
                    </label>
                    <input
                        type="text"
                        id="first_name"
                        name="first_name"
                        value="{{ user.first_name }}"
                        required
                        minlength="1"
                        maxlength="100"
                        class="w-full"
                        aria-label="First name"
                        aria-required="true"
                        aria-describedby="first_name-error"
                        aria-invalid="false"
                    >
                    <div id="first_name-error" class="text-xs text-red-600 mt-1" role="alert" aria-live="polite"></div>
                </div>

                <!-- Avatar Upload -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Profile Avatar
                    </label>
                    <div class="flex items-center gap-4">
                        <div class="profile-avatar profile-avatar-medium" id="avatar-preview">
                            {% if user.avatar_path %}
                                <img src="/static/avatars/{{ user.avatar_path }}" alt="{{ user.first_name }}" class="w-full h-full object-cover rounded-full">
                            {% else %}
                                {{ user.first_name[0] }}
                            {% endif %}
                        </div>
                        <div class="flex-1">
                            <input
                                type="file"
                                id="avatar"
                                name="avatar"
                                accept="image/*"
                                class="hidden"
                                onchange="handleAvatarSelect(this)"
                            >
                            <label for="avatar" class="btn-secondary inline-block mb-2 cursor-pointer">
                                Change Avatar
                            </label>
                            <p class="text-xs text-gray-500">Max 500KB, 512x512px</p>
                            <p id="avatar-status" class="text-xs mt-1"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Interests Section -->
        <div class="border-b border-gray-200 pb-8">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Your Interests</h2>

            <!-- Selected Interests -->
            <div class="coral-bg-light rounded-lg p-4 mb-4 min-h-[60px]">
                <div class="text-xs text-gray-600 uppercase tracking-wide font-semibold mb-2">
                    Selected Interests (click to remove)
                </div>
                <div id="selected-interests" class="flex flex-wrap gap-2">
                    {% if user_interests %}
                        {% for interest in user_interests %}
                        <span class="interest-tag cursor-pointer hover:opacity-80" data-interest="{{ interest }}">
                            {{ interest }}
                        </span>
                        {% endfor %}
                    {% else %}
                        <span class="text-xs text-gray-500 empty-state">
                            No interests selected yet. Add your interests to personalize your news!
                        </span>
                    {% endif %}
                </div>
            </div>

            <!-- Custom Interest Input -->
            <div class="mb-4">
                <div class="flex gap-2">
                    <input
                        type="text"
                        id="custom-interest"
                        placeholder="Add custom interest..."
                        maxlength="100"
                        class="flex-1"
                        aria-label="Custom interest"
                        aria-describedby="custom-interest-error"
                        aria-invalid="false"
                    >
                    <button type="button" class="btn-secondary" id="add-custom-btn">
                        Add
                    </button>
                </div>
                <div id="custom-interest-error" class="text-xs text-red-600 mt-1" role="alert" aria-live="polite"></div>
            </div>

            <!-- Available Interests -->
            <div class="mb-2">
                <div class="text-xs text-gray-600 uppercase tracking-wide font-semibold mb-2">
                    Pre-configured Categories (click to add)
                </div>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2">
                {% for interest in available_interests %}
                <button
                    type="button"
                    class="interest-tag text-center {% if interest in user_interests %}selected{% endif %}"
                    data-interest="{{ interest }}"
                >
                    {{ interest }}
                </button>
                {% endfor %}
            </div>
        </div>

        <!-- Account Stats -->
        <div class="border-b border-gray-200 pb-8">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Account Statistics</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="stats-box">
                    <div class="stats-number coral-accent">{{ stats.interests_count }}</div>
                    <div class="stats-label">Active Interests</div>
                </div>
                <div class="stats-box">
                    <div class="stats-number">{{ stats.this_month }}</div>
                    <div class="stats-label">Newsletters This Month</div>
                </div>
                <div class="stats-box">
                    <div class="stats-number">{{ stats.total }}</div>
                    <div class="stats-label">Total Newsletters</div>
                </div>
                <div class="stats-box">
                    <div class="stats-number">{{ stats.retention_days }}</div>
                    <div class="stats-label">Days Retention</div>
                </div>
            </div>
        </div>

        <!-- Danger Zone -->
        <div>
            <h2 class="text-xl font-bold text-red-600 mb-4">Danger Zone</h2>
            <div class="border-2 border-red-200 rounded-lg p-4 bg-red-50">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="font-semibold text-gray-900">Delete Profile</h3>
                        <p class="text-sm text-gray-600">Permanently delete this profile and all newsletters</p>
                    </div>
                    <button
                        type="button"
                        class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition-colors"
                        hx-delete="/profile/{{ user.id }}"
                        hx-confirm="Are you sure you want to delete this profile? This action cannot be undone and will delete all your newsletters."
                        hx-indicator="#delete-spinner"
                        hx-disabled-elt="this"
                        data-delete-profile
                    >
                        <span id="delete-spinner" class="htmx-indicator">Deleting...</span>
                        <span class="htmx-not-indicator">Delete Profile</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Submit Buttons -->
        <div class="flex gap-4 pt-6">
            <button type="submit" class="btn-primary flex-1" id="submit-btn">
                Save Changes
            </button>
            <a href="/calendar" class="btn-secondary flex-1 text-center">
                Cancel
            </a>
        </div>
    </form>
</div>

<script type="module">
    import { AvatarManager } from '/static/avatar-manager.js';
    import { InterestManager } from '/static/interest-manager.js';
    import { FormAccessibility } from '/static/form-accessibility.js';

    // Set up accessibility for form inputs
    FormAccessibility.setupTextInput('first_name', 'First name is required');
    FormAccessibility.setupFileInput('avatar');

    // Interest manager instance
    const interestManager = new InterestManager();
    interestManager.initialize({{ user_interests|tojson }});  // Initialize with existing interests

    let uploadedAvatarFile = null;

    // Add event delegation for interest removal (safe from XSS)
    document.getElementById('selected-interests').addEventListener('click', function(e) {
        const interestTag = e.target.closest('.interest-tag[data-interest]');
        if (interestTag && !interestTag.classList.contains('empty-state')) {
            const interest = interestTag.dataset.interest;
            interestManager.remove(interest);
        }
    });

    // Add event listeners for predefined interest grid (safe from XSS)
    document.querySelectorAll('.interest-tag[data-interest]').forEach(btn => {
        btn.addEventListener('click', function() {
            const interest = this.dataset.interest;
            interestManager.toggle(this, interest);
        });
    });

    // Add custom interest button click handler (safe from XSS)
    document.getElementById('add-custom-btn').addEventListener('click', function() {
        interestManager.addCustom('custom-interest');
    });

    // Handle avatar file selection using shared module
    window.handleAvatarSelect = async function(input) {
        await AvatarManager.handleAvatarSelect(
            input,
            'avatar-preview',
            'avatar-status',
            true  // Upload immediately in settings
        );
    };

    // Make interest management functions available globally
    window.toggleInterest = (btn, interest) => interestManager.toggle(btn, interest);
    window.addCustomInterest = () => interestManager.addCustom('custom-interest');

    // Allow Enter key to add custom interest
    document.getElementById('custom-interest').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            interestManager.addCustom('custom-interest');
        }
    });

    // Form submission handler
    document.getElementById('settings-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const firstName = document.getElementById('first_name').value.trim();
        const interests = interestManager.getSelected();

        if (!firstName) {
            alert('Please enter your first name');
            return;
        }

        // Disable submit button
        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Saving...';

        try {
            const response = await fetch('/profile/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    first_name: firstName,
                    interests: interests
                })
            });

            if (response.ok) {
                // Success - parse JSON response to be consistent
                const result = await response.json();
                if (result.status === 'success') {
                    // Redirect with success message in query string
                    window.location.href = '/calendar?toast=Profile updated successfully!&toast_type=success';
                } else {
                    throw new Error(result.message || 'Update failed');
                }
            } else {
                // Handle error with safe JSON parsing
                let errorMessage = 'An unexpected error occurred. Please try again.';
                try {
                    const error = await response.json();
                    errorMessage = error.detail || errorMessage;
                } catch (parseError) {
                    // Response wasn't JSON (e.g., 500 HTML page)
                    console.error('Failed to parse error response:', parseError.message);
                }
                throw new Error(errorMessage);
            }
        } catch (error) {
            console.error('Error:', error.message);
            alert(error.message || 'Network error. Please try again.');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Save Changes';
        }
    });

    // Handle profile deletion responses (global listener, no memory leak)
    document.body.addEventListener('htmx:afterRequest', function(evt) {
        // Only handle delete profile requests
        if (evt.detail.target.hasAttribute('data-delete-profile')) {
            if (evt.detail.successful) {
                // Successful deletion - redirect to profile selection
                window.location.href = '/?toast=Profile deleted successfully&toast_type=success';
            } else {
                // Failed deletion - show actual error from server
                let errorMessage = 'Failed to delete profile. Please try again.';
                try {
                    const response = JSON.parse(evt.detail.xhr.responseText);
                    if (response.detail) {
                        errorMessage = response.detail;
                    }
                } catch (e) {
                    // Response wasn't JSON, use default message
                }
                alert(errorMessage);
            }
        }
    });
</script>
{% endblock %}
